+++
title = "Состояние в Terrafrom"
lastmod = 2023-07-21
tags = ["Terraform"]
draft = false
+++

Под состоянием или state в Terraform понимается состояние инфраструктуры и конфигурации, о котором "знает" Terraform. При этом оно вполне может отличаться от фактического состояния ресурсов. В самом простом варианте состояние хранится в файле `terraform.tfstate` и представляет собой JSON файл.
Лучшие практики в работе с tfstate:

-   Не редактировать файл состояния вручную. Файл не предназначен для ручного редактирования.
-   Хранить файл в защищённом месте, поскольку в нём содержаться секретные данные в виде простого текста.
-   Делать регулярные бэкапы файлов состояния.
-   В случае работы команды файл состояния надо хранить в удалённом хранилище, желательно с поддержкой версионирования для возможности отката к старым версиям.


## Какая команда создаёт файл состояния? {#какая-команда-создаёт-файл-состояния}

`terraform apply`


## Как просмотреть текущее состояние? {#как-просмотреть-текущее-состояние}

`terraform show`


## Как просмотреть ресурсы, созданные через Terraform? {#как-просмотреть-ресурсы-созданные-через-terraform}

`terraform state list`


## Как переименовать существующий ресурс? {#как-переименовать-существующий-ресурс}

`terraform state mv`


## Переключение на удалённый бэкенд {#переключение-на-удалённый-бэкенд}

По умолчанию для работы с состоянием используется бэкенд `local`, но можно и нужно использовать удалённые бэкенды на свой выбор. Переключение бэкенда на примере перехода на S3:

-   Написать tf код для создания бакета в S3, хорошей идеей будет добавить параметр `prevent_destroy` в жизненный цикл.
-   Включить версионирование бакета.
-   Включить шифрование.
-   Заблокировать публичный доступ.
-   Решить как будет реализована блокировка.
-   Применить код чтобы бакет был создан.
-   Переключиться в коде на использование удалённого бэкенда:
    ```hcl
    terraform {
      backend "s3" {
        bucket ...
      }
    }
    ```
-   Запустить `terraform init` чтобы переключиться на удалённый бэкенд.


## Что меняется в выполнении `terraform apply` при использовании удалённого бэкенда? {#что-меняется-в-выполнении-terraform-apply-при-использовании-удалённого-бэкенда}

Выполнение `terraform apply` начинается с блокировки состояния чтобы предотвратить изменения в конфигурацию ресурсов.


## Как переключиться обратно с удалённого бэкенда на локальный? {#как-переключиться-обратно-с-удалённого-бэкенда-на-локальный}

-   Удалить код, определяющий удалённый бэкенд и снова запустить `terraform init`
-   Удалить ресурсы, представляющие сам бэкенд(например, бакет в случае S3)


## Возможно ли использовать переменные в конфигурации бэкенда? {#возможно-ли-использовать-переменные-в-конфигурации-бэкенда}

Нет, нельзя. Придётся вручную пойти в консоль облачного провайдера и скопировать значения оттуда.
Есть костыль в виде хранения части конфигурации бэкенда локально и загрузке её при выполнении:
`terraform init -backend-config=some_backend_partial_conf.hcl`


## Как можно получить данные из удалённого бэкенда? {#как-можно-получить-данные-из-удалённого-бэкенда}

С использованием [источников данных]({{< relref "20230721184310-data_sources_в_terraform.md" >}}). В частности, можно использовать такой синтакс:
`data.terraform_remote_state.<NAME>.outputs.<ATTRIBUTE>`
