+++
title = "Структуры данных Terraform"
lastmod = 2023-07-21
tags = ["Terraform"]
draft = false
+++

## Как определить переменную в виде списка чисел? {#как-определить-переменную-в-виде-списка-чисел}

```hcl
variable "list_of_nums" {
  type = list(number)
  description = "An example of list of numbers"
  default = [2, 0, 1, 7]
}
```


## Как создать ресурсы в количестве, равном длине списка? {#как-создать-ресурсы-в-количестве-равном-длине-списка}

```hcl
resource "some_resource" "some_name" {
  count = length(var.some_list)
}
```


## Как получить аттрибут "name" второго элемента списка "users"? {#как-получить-аттрибут-name-второго-элемента-списка-users}

```hcl
users[1].name
```


## Как получить аттрибут "name" всех элементов списка "users"? {#как-получить-аттрибут-name-всех-элементов-списка-users}

```hcl
users[*].name
```


## Для чего используются циклы в Terraform? {#для-чего-используются-циклы-в-terraform}

Чаще всего для создания нескольких ресурсов, различающихся незначительно: например только именем.


## Пример простого цикла в Terraform {#пример-простого-цикла-в-terraform}

```hcl
resource "aws_instance" "server" {
  count = 15
}
```

Эта конфигурация создаст 15 экземпляров инстансов AWS. Если мы хотим задать имена здесь же, фрагмент кода будет выглядеть так:

```hcl
resource "aws_instance" "server" {
  count = 15
  tags = {
    Name = "instance-${count.index}"
  }
}
```


## Как использовать значения из списка в цикле? {#как-использовать-значения-из-списка-в-цикле}

Допустим, у нас есть такой список имён пользователей:

```hcl
variable "users" {
  type    = list(string)
  default = ["mario", "luigi", "peach"]
}
```

Чтобы создать пользователей(или другой ресурс) с именами из списка, можно использовать такой код:

```hcl
resource "aws_iam_user" "user" {
  count = length(var.users)

  name = var.users[count.index]
}
```


## Ограничения при использовании `count` {#ограничения-при-использовании-count}

1.  `сount` нельзя использовать во вложенных блоках.
2.  использование `count` в работе со списками имеет свои особенности. Например, при удалении элементов из списка, остальные элементы меняют индекс, что может привести к непредвиденным последствиям. Есть способы избежать такого поведения, но в целом при использовании `count` нужно быть осторожным.


## Что такое цикл `for_each` и чем он отличается от `count`? {#что-такое-цикл-for-each-и-чем-он-отличается-от-count}

-   `for_each` может использоваться только с типами коллеций, как мапы(maps) и наборы(sets), в отличие от `count`, применяемого со списками.
-   `for_each` может использоваться во вложенных блоках.


## Пример использования цикла `for_each` {#пример-использования-цикла-for-each}

```hcl
resource “google_compute_instance” “instances” {
  for_each = var.names_map
  name = each.value
}
```


## Как `for_each` используется во вложенных блоках? {#как-for-each-используется-во-вложенных-блоках}

```hcl
resouce "some_instance" "instance" {
dynamic "tag" {
  for_each = var.tags
  content {
    key   = tag.key
    value = tag.value
    }
  }
}
```
