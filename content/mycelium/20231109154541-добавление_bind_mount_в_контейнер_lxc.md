+++
title = "Добавление bind-mount в контейнер LXC"
date = 2023-11-09T00:00:00+03:00
lastmod = 2023-12-15
tags = ["LXC", "Proxmox"]
draft = false
+++

## Постановка задачи {#постановка-задачи}

Задача в том чтобы смонтировать директорию с [Proxmox]({{< relref "20231109154741-proxmox.md" >}}) хоста внутрь непривилегированного контейнера [LXC]({{< relref "20231109155134-lxc.md" >}}). Например, мы подключили к хосту Proxmox внешний HDD, на котором хотим организовать файловую шару и/или торрентокачалку. Далее будем считать что диск примонтирован на хосте в директорию `/mnt/datastorage`. Мы хотим чтобы внутри контейнера с ID 100 можно было читать и записывать данные в эту директорию.


## Добавление точки монтирования контейнеру {#добавление-точки-монтирования-контейнеру}

На момент написания заметки в Proxmox 8.0.4 нельзя добавить точку монтирования через веб-интерфейс, поэтому придётся подключиться к хосту напрямую и отредактировать файл `/etc/pve/lxc/<CT_ID>.conf` где `<CT_ID>` это ID контейнера, в нашем примере будет 100. В этот конфиг нужно добавить следующую строчку:

```cfg
mp0:/mnt/datastorage,mp=/mnt/datastorage
```

В примере директория хоста `/mnt/datastorage` будет смонтирована внутрь контейнера по такому же пути, но в принципе можно использовать разные пути.


## Создание группы на хосте {#создание-группы-на-хосте}

По-умолчанию Proxmox транслирует группы контейнеров в группы хоста с префиксом 10. То есть если внутри контейнера директория принадлежит пользователю в группе 1000, на хосте она должна принадлежать группе 101000. Создадим эту группу на хосте:

```bash
addgroup --gid 101000 container-data
chgrp -R container-data /mnt/datastorage
chmod -R 2755 /mnt/datastorage

# Эта команда мне не пригодилась, в дефолтной конфигурации Proxmox ACL отключен
setfacl -Rm g:101000:rwx,d:g:101000:rwx /mnt/datastorage
```


## Создание группы внутри контейнера {#создание-группы-внутри-контейнера}

Если внутри контейнера создан не-рутовый пользователь, скорее всего группа с ID 1000 уже присутствует, но на всякий случай команды для создания группы и добавления пользователя в группу аналогичные:

```bash
addgroup --gid 1000 container-data
usermod -aG container-data user
```

После этого директория будет доступна и с хоста, и изнутри контейнера.
