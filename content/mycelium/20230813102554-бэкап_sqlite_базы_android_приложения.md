+++
title = "Бэкап SQLite базы Android приложения"
date = 2023-08-13T00:00:00+03:00
lastmod = 2023-08-13
tags = ["snippets", "SQL", "Android", "SQLite"]
draft = false
+++

## Вводная часть {#вводная-часть}

Допустим у нас на телефоне установлено приложение, которое более не поддерживается автором по неизвестным причинам. Для примера пускай будет приложение для учёта наблюдений за птичками. В самом приложении накоплен массив данных(время, место и вид наблюдаемых птичек), которые жалко потерять. Но в то же время, автор приложения не предусмотрел возможность сделать экспорт данных во внешний универсальный формат, например CSV. В таком случае нам может помочь [Android Debug Bridge](https://developer.android.com/tools/adb) или `adb`.


## Установка adb {#установка-adb}

Есть разные способы установки `adb` на компьютер, наиболее простым мне видится загрузка бинарников Android Platform Tools и размещение их где-нибудь в `$PATH`. После установки команда `adb version` покажет текущую доступную версию `adb` и путь, по которому мы разместили файл.


## Настройка устройства {#настройка-устройства}

Другим необходимым шагом является включение дебаг-режима на Android устройстве. На разных устройствах это может делаться немного по-разному, но общий принцип везде одинаковый:

-   Найти или включить пункт меню "Для разработчиков"
-   В этом меню включить "Отладка по USB"
-   При подключении устройства к компьютеру разрешить(на устройстве) доступ для отладки

В целом ничего сложного, инструкции для конкретных устройств скорее всего уже кем-то написаны на случай если не получается разобраться самостоятельно.


## Бэкап приложения {#бэкап-приложения}

Сначала мы подключимся к устройству и сделаем бэкап нужного нам приложения(или всех разом). Результатом будет один файл с расширением `.adb`, который мы позже сможем распаковать чтобы извлечь данные приложения.
Сначала нужно узнать имя пакета с нужным нам приложением. Для этого есть специальные приложения, которые можно найти по запросу типа "package name viewer android". Либо можно просто вывести список всех доступных на устройстве приложений командой:

```bash
adb shell pm list packages
```

Список может оказаться большим, так что рекомендуется сделать grep чтобы найти приложение по части названия. Например, если мы ищем приложение для наблюдения за птичками, в названии скорее всего будет часть "bird", так что можно попробовать такую команду:

```bash
adb shell pm list packages | grep bird
```

Предположим что название нашего приложения — `com.fakeapps.birdwatching`. В таком случае мы можем сделать бэкап отдельного приложения такой командой:

```bash
adb backup -apk com.fakeapps.birdwatching -f birdwatching_backup.adb
```

Либо можем забэкапить все установленные приложения в единственный файл:

```bash
adb backup -f all -all -apk -nosystem
```

Либо каждое приложение в отдельный файлик:

```bash
for APP in $(adb shell pm list packages -3)
do
  APP=$( echo ${APP} | sed "s/^package://")
  adb backup -f ${APP}.backup ${APP}
done
```


## Восстановление из бэкапа {#восстановление-из-бэкапа}

Сначала устанавливаем apk файл:

```bash
adb install application.apk
```

А затем восстанавливаем данные приложения:

```bash
adb restore application.backup
```


## Распаковка бэкапа приложения {#распаковка-бэкапа-приложения}

Для этого трюка нам понадобится программа `zlib-flate`, в [Ubuntu]({{< relref "20230805105255-ubuntu_linux.md" >}}) это пакет `qpdf`, установим его:

```bash
sudo apt install -y qpdf
```

После этого можем попробовать распаковать наш файлик с бэкапом:

```bash
dd if=birdwatching_backup.adb bs=24 skip=1 | zlib-flate -uncompress | tar xf -
```

В директории с файлом бэкапа появится новая директория `apps`, внутри которой будут данные приложений, содержащихся в бэкапе.
После этого остаётся только отыскать среди файлов приложения файл с расширением `.db` или `.sqlite`.
Способ далеко не универсален, потому что приложение может не хранить нужные нам данные в базе на самом устройстве, а хранить их на каком-нибудь облачном сервисе(не пользуйтесь такими приложениями). В отдельных случаях приложение может хранить данные в зашифрованном виде и тогда мы скорее всего в пролёте. Но если нам повезло и получилось достать файл с базой SQLite, далее мы вольны манипулировать данными как нам угодно.
