+++
title = "Красный дракон"
date = 2023-07-09T00:00:00+03:00
lastmod = 2023-07-19
tags = ["nethack", "povray"]
draft = false
+++

{{< figure src="/ox-hugo/nhsplash.png" >}}


## Предыстория {#предыстория}

Я играю в [NetHack](https://nethack.org/) уже очень-очень давно. Моё первое непродолжительное знакомство с этой игрой состоялось приблизительно в 2006 году, но на тот момент моего знания английского не хватало на то чтобы полноценно начать играть. Постоянного доступа к интернету для общения с другими игроками у меня в то время не было, сама игра очень сложная без подсказок, так что довольно скоро я оставил попытки и не прошёл даже Гномьи Шахты. Снова вернулся к этой игре я лишь спустя пять лет, уже будучи студентом. Фактически NetHack является той игрой, которая прошла со мной через годы, в которую я играл и играю в разных версиях, на разных устройствах и которая всё ещё имеет огромный простор для реиграбельности и много тайн.

Одной из таких загадок для меня являлось изображение всадника на красном драконе, появляющееся при запуске графической версии NetHack на Windows, да и на других платформах думаю тоже. И хоть практически с самого начала я играю в режиме без тайлсетов в текстовой псевдографике, этот всадник на дракончике чем-то запал в мою память ещё со школьных лет, когда я впервые запускал NetHack 3.4.3 на компьютере с Windows XP и безуспешно пытался исследовать жестокий мир игры.


## История {#история}

И вот, уже в 2023 году я наконец-то решил разобраться с историей происхождения этой картинки. Начал, как говорится, с начала — с поисков в [исходном коде игры](https://github.com/NetHack/NetHack), который уже довольно давно доступен на GitHub. В исходниках графической версии довольно быстро нашёлся [файл](https://github.com/NetHack/NetHack/blob/NetHack-3.7/win/share/nhsplash.xpm) с самим изображением всадника из заголовка этой статьи.

Сейчас я понимаю, что если бы копнул чуть глубже в исходниках, смог бы найти имя автора изображения и уже по имени автора найти исходник. Но об этом чуть позднее. Чтобы установить происхождение драконьего всадника, я создал пост с вопросом в сабреддите [r/nethack](https://www.reddit.com/r/nethack/), где довольно быстро получил ответ — оригинальное изображение участвовало в [The Internet Raytracing Competition](https://www.irtc.org/) в 1997 году.

"Dragon Rider" (1997) by Warwick Allison:
![](/ox-hugo/dragonri.jpg)

Уже интереснее! Вместе с изображением доступен [текстовый файл](https://www.irtc.org/ftp/pub/stills/1997-08-31/dragonri.txt) с указанием авторства и заметкой от том, как было создано конкурсное изображение.

Сначала немного об авторе: это некий Warwick Allison, судя по всему, он был участником DevTeam и поддерживал Qt версию NetHack в нулевых и поэтому добавил свою картинку с драконом. Кроме того он приложил руку и к другим opensource играм, например к [Freeciv](http://freeciv.org/). Похоже [этот канал](https://www.youtube.com/@WarwickAllison) на YouTube принадлежит ему же, но я не пытался с ним связаться.

Но что **действительно** интересно — вместе с готовыми рендерами и текстовыми файлами на сайте IRTC до сих пор доступны архивы с исходниками и в этот момент я задался целью сделать "HD ремастер" драконьего всадника.


## Технологии древних {#технологии-древних}

После прочтения текстового файла от автора оригинального изображения, я узнал новое для себя слово POV-Ray и открыл для себя древние технологии трёхмерной графики в эпоху до современных редакторов.

Если пытаться объяснить простым языком, то [POV-Ray](http://www.povray.org/) это специальная программа, которая принимает на вход текстовые файлы, содержащие описание трёхмерной сцены(геометрия объектов, расположение камеры, источники освещения, различные эффекты) на специальном языке, а на выходе генерирует растровый графический файл. Из плюсов такого подхода: низкие требования к системе, для работы достаточно текстового редактора, а сам рендер можно запускать на другой машине. Описание сцены по-сути представляет собой программу, получается такой CGI as a code подход, что интересно само по себе. Из очевидных минусов — невозможность смотреть изменения в реальном времени, но с учётом скорости рендера на современных компьютерах и возможности во время разработки использовать низкие настройки качества, это не такая уж и проблема.

Проект продолжает развиваться, несмотря на свой возраст, кроме уже упомянутого IRTC на официальном сайте есть [галерея](https://hof.povray.org/) избранных работ. POV-Ray также используется для создания иллюстраций к различным научным статьям, а кроме того для создания анимаций. Сложилось впечатление, что сейчас это такой не мейнстримный способ создания трёхмерной графики, который может быть даже удобнее условного Blender, например для визуализации научных данных.

Моя же затея состояла в том чтобы запустить рендеринг исходного изображения с драконьим всадником, используя современную версию POV-Ray и в высоком разрешении. Оригинал был сделан для версии POV-Ray 3.0, я же адаптировал код для актуальной 3.7. Изменений пришлось сделать немного: с определённой версии точки с запятой в конце строк стали обязательными, так что пришлось их добавить и отдельно пришлось разобраться как переписать на современную версию свечение вокруг навершия посоха всадника.

-   Вот та же картинка, но в разрешении 1900\*1080:

{{< figure src="/ox-hugo/dragonrider.png" >}}

-   Кроме того, поскольку мы работаем с исходным кодом, можно проворачивать интересные штуки, например изменить цвета(здесь изображение растянуто вдоль горизонтали потому что на тот момент я ещё не разобрался как указать правильный aspect ratio):

{{< figure src="/ox-hugo/dragonrider_blue.png" >}}

-   Или взглянуть на сцену с другого положения камеры(в коде было закомментировано несколько позиций для камеры):

{{< figure src="/ox-hugo/distance.png" >}}

-   Ну и наконец, отдельные элементы сцены могут включаться и выключаться условными блоками, так что можно отключить всё кроме дракона и всадника и получить улучшенную версию картинки из начала статьи:

{{< figure src="/ox-hugo/dragonrider_no_background.png" >}}


## Итоги {#итоги}

Мне нравится такого рода "цифровая археология". Вдвойне приятно найти пример технологии, которая жизнеспособна и даже обратно совместима на временном промежутке в 25 лет. Кроме удовлетворения любопытства узнал немного больше об истории и технологиях трёхмерной графики, сделал себе несколько крутых обоин на рабочий стол в ретро стиле и в целом интересно провёл время. Мне кажется что POV-Ray это возможность заниматься 3D как хобби если ты больше программист чем художник.
